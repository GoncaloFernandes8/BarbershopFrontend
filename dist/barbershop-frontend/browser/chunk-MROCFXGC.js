import{a as E}from"./chunk-IFE72Z7Y.js";import{Aa as b,Ba as v,Ia as g,e as u,f as h,g as d,k as n,n as f,q as a,t as c}from"./chunk-VTAVQ2BQ.js";var p=class s{notifications=[];router=c(g);handleError(e){let t="Ocorreu um erro inesperado.",r;if(e.error instanceof ErrorEvent)t=e.error.message;else{let o=e.error;if(o)t=o.message||t,r=o.fieldErrors;else switch(e.status){case 0:t="Erro de conex\xE3o. Verifique sua internet e tente novamente.";break;case 400:t="Dados inv\xE1lidos. Verifique as informa\xE7\xF5es inseridas.";break;case 401:return this.handleTokenExpiration(),h(()=>e);case 403:t="Acesso negado. Voc\xEA n\xE3o tem permiss\xE3o para esta a\xE7\xE3o.";break;case 404:t="Recurso n\xE3o encontrado.";break;case 409:t="Conflito de dados. Esta informa\xE7\xE3o j\xE1 existe.";break;case 422:t="Dados de valida\xE7\xE3o inv\xE1lidos. Verifique os campos destacados.";break;case 429:t="Muitas tentativas. Aguarde um momento e tente novamente.";break;case 500:t="Erro interno do servidor. Tente novamente mais tarde.";break;case 503:t="Servi\xE7o temporariamente indispon\xEDvel. Tente novamente em alguns minutos.";break;default:e.status>=500?t="Erro do servidor. Tente novamente mais tarde.":e.status>=400?t="Erro na requisi\xE7\xE3o. Verifique os dados e tente novamente.":t=`Erro ${e.status}: ${e.statusText}`}}let i=new b({error:{message:t,fieldErrors:r},status:e.status,statusText:e.statusText});return h(()=>i)}getFieldError(e,t){return e?.[t]||null}hasFieldErrors(e){return e?Object.keys(e).length>0:!1}showError(e){this.showNotification(e,"error")}showSuccess(e){this.showNotification(e,"success")}showWarning(e){this.showNotification(e,"warning")}showInfo(e){this.showNotification(e,"info")}showNotification(e,t){let r=document.createElement("div");r.className=`notification notification-${t}`,r.textContent=e,Object.assign(r.style,{position:"fixed",top:"20px",left:"50%",transform:"translateX(-50%) translateY(-100%)",padding:"16px 24px",borderRadius:"12px",fontWeight:"600",fontSize:"14px",zIndex:"9999",maxWidth:"500px",width:"90%",wordWrap:"break-word",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.4)",transition:"transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)",textAlign:"center",border:"2px solid transparent"});let i={error:"#ef4444",success:"#C3FF5A",warning:"#f59e0b",info:"#3b82f6"},o={error:"white",success:"#0f0f11",warning:"white",info:"white"};r.style.backgroundColor=i[t],r.style.color=o[t],document.body.appendChild(r),setTimeout(()=>{r.style.transform="translateX(-50%) translateY(0)"},100),setTimeout(()=>{r.style.transform="translateX(-50%) translateY(-100%)",setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},400)},5e3)}getNotifications(){return[...this.notifications]}clearNotifications(){this.notifications=[]}handleTokenExpiration(){localStorage.removeItem("token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),this.showError("Sess\xE3o expirada. Por favor, fa\xE7a login novamente."),setTimeout(()=>{this.router.navigate(["/login"])},2e3)}static \u0275fac=function(t){return new(t||s)};static \u0275prov=a({token:s,factory:s.\u0275fac,providedIn:"root"})};var l=class s{cache=new Map;DEFAULT_TTL=5*60*1e3;set(e,t,r){let i=Date.now(),o=r||this.DEFAULT_TTL;this.cache.set(e,{data:t,timestamp:i,expiry:i+o})}get(e){let t=this.cache.get(e);return t?Date.now()>t.expiry?(this.cache.delete(e),null):t.data:null}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}has(e){let t=this.cache.get(e);return t?Date.now()>t.expiry?(this.cache.delete(e),!1):!0:!1}getOrSet(e,t,r){let i=this.get(e);return i!==null?u(i):t().pipe(f(o=>this.set(e,o,r)))}cleanup(){let e=Date.now();for(let[t,r]of this.cache.entries())e>r.expiry&&this.cache.delete(t)}getStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}static \u0275fac=function(t){return new(t||s)};static \u0275prov=a({token:s,factory:s.\u0275fac,providedIn:"root"})};var A=class s{http=c(v);errorHandler=c(p);cache=c(l);API=E.apiUrl;SERVICES_CACHE_KEY="services";BARBERS_CACHE_KEY="barbers";CACHE_TTL=10*60*1e3;getAppointmentById(e){return this.http.get(`${this.API}/appointments/${e}`).pipe(n(t=>this.errorHandler.handleError(t)))}getServiceById(e){return this.http.get(`${this.API}/services/${e}`).pipe(n(t=>this.errorHandler.handleError(t)))}getServices(){return this.cache.getOrSet(this.SERVICES_CACHE_KEY,()=>this.http.get(`${this.API}/services`).pipe(n(e=>this.errorHandler.handleError(e))),this.CACHE_TTL)}getBarberById(e){return this.getBarbers().pipe(d(t=>t.find(r=>r.id===e)))}getBarbers(){return this.cache.getOrSet(this.BARBERS_CACHE_KEY,()=>this.http.get(`${this.API}/barbers`).pipe(n(e=>this.errorHandler.handleError(e))),this.CACHE_TTL)}getAvailability(e,t,r){return this.http.get(`${this.API}/availability`,{params:{barberId:e,serviceId:t,date:r}}).pipe(n(i=>this.errorHandler.handleError(i)))}createAppointment(e){return this.http.post(`${this.API}/appointments`,e,{observe:"response"}).pipe(d(t=>{let r=t.body?.id;if(typeof r=="string"&&r.length)return this.errorHandler.showSuccess("Marca\xE7\xE3o realizada com sucesso!"),r;let i=t.headers.get("Location")||t.headers.get("location");if(i){try{let m=new URL(i,this.API).pathname.split("/").filter(Boolean).pop();if(m)return this.errorHandler.showSuccess("Marca\xE7\xE3o realizada com sucesso!"),m}catch{}let o=i.match(/\/([^\/\?]+)(?:\?.*)?$/);if(o)return this.errorHandler.showSuccess("Marca\xE7\xE3o realizada com sucesso!"),o[1]}throw new Error("O servidor n\xE3o devolveu o ID da marca\xE7\xE3o.")}),n(t=>(this.errorHandler.showError("Erro ao criar marca\xE7\xE3o. Tente novamente."),this.errorHandler.handleError(t))))}invalidateServicesCache(){this.cache.delete(this.SERVICES_CACHE_KEY)}invalidateBarbersCache(){this.cache.delete(this.BARBERS_CACHE_KEY)}invalidateAllCache(){this.cache.clear()}refreshServices(){return this.invalidateServicesCache(),this.getServices()}refreshBarbers(){return this.invalidateBarbersCache(),this.getBarbers()}getUserAppointments(){return this.http.get(`${this.API}/appointments/my`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}}).pipe(n(e=>this.errorHandler.handleError(e)))}static \u0275fac=function(t){return new(t||s)};static \u0275prov=a({token:s,factory:s.\u0275fac,providedIn:"root"})};export{A as a};

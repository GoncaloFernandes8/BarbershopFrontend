import{a as u,b as v}from"./chunk-ID5D7IBA.js";import{Ba as m,e as b,g as p,k as s,n as d,q as o,t as c}from"./chunk-VTAVQ2BQ.js";var h=class n{cache=new Map;DEFAULT_TTL=5*60*1e3;set(e,r,t){let i=Date.now(),a=t||this.DEFAULT_TTL;this.cache.set(e,{data:r,timestamp:i,expiry:i+a})}get(e){let r=this.cache.get(e);return r?Date.now()>r.expiry?(this.cache.delete(e),null):r.data:null}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}has(e){let r=this.cache.get(e);return r?Date.now()>r.expiry?(this.cache.delete(e),!1):!0:!1}getOrSet(e,r,t){let i=this.get(e);return i!==null?b(i):r().pipe(d(a=>this.set(e,a,t)))}cleanup(){let e=Date.now();for(let[r,t]of this.cache.entries())e>t.expiry&&this.cache.delete(r)}getStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}static \u0275fac=function(r){return new(r||n)};static \u0275prov=o({token:n,factory:n.\u0275fac,providedIn:"root"})};var f=class n{http=c(m);errorHandler=c(v);cache=c(h);API=u.apiUrl;SERVICES_CACHE_KEY="services";BARBERS_CACHE_KEY="barbers";CACHE_TTL=10*60*1e3;getAppointmentById(e){return this.http.get(`${this.API}/appointments/${e}`).pipe(s(r=>this.errorHandler.handleError(r)))}getServiceById(e){return this.http.get(`${this.API}/services/${e}`).pipe(s(r=>this.errorHandler.handleError(r)))}getServices(){return this.cache.getOrSet(this.SERVICES_CACHE_KEY,()=>this.http.get(`${this.API}/services`).pipe(s(e=>this.errorHandler.handleError(e))),this.CACHE_TTL)}getBarberById(e){return this.getBarbers().pipe(p(r=>r.find(t=>t.id===e)))}getBarbers(){return this.cache.getOrSet(this.BARBERS_CACHE_KEY,()=>this.http.get(`${this.API}/barbers`).pipe(s(e=>this.errorHandler.handleError(e))),this.CACHE_TTL)}getAvailability(e,r,t){return this.http.get(`${this.API}/availability`,{params:{barberId:e,serviceId:r,date:t}}).pipe(s(i=>this.errorHandler.handleError(i)))}createAppointment(e){return this.http.post(`${this.API}/appointments`,e,{observe:"response"}).pipe(p(r=>{let t=r.body?.id;if(typeof t=="string"&&t.length)return this.errorHandler.showSuccess("Marca\xE7\xE3o realizada com sucesso!"),t;let i=r.headers.get("Location")||r.headers.get("location");if(i){try{let l=new URL(i,this.API).pathname.split("/").filter(Boolean).pop();if(l)return this.errorHandler.showSuccess("Marca\xE7\xE3o realizada com sucesso!"),l}catch{}let a=i.match(/\/([^\/\?]+)(?:\?.*)?$/);if(a)return this.errorHandler.showSuccess("Marca\xE7\xE3o realizada com sucesso!"),a[1]}throw new Error("O servidor n\xE3o devolveu o ID da marca\xE7\xE3o.")}),s(r=>(this.errorHandler.showError("Erro ao criar marca\xE7\xE3o. Tente novamente."),this.errorHandler.handleError(r))))}invalidateServicesCache(){this.cache.delete(this.SERVICES_CACHE_KEY)}invalidateBarbersCache(){this.cache.delete(this.BARBERS_CACHE_KEY)}invalidateAllCache(){this.cache.clear()}refreshServices(){return this.invalidateServicesCache(),this.getServices()}refreshBarbers(){return this.invalidateBarbersCache(),this.getBarbers()}static \u0275fac=function(r){return new(r||n)};static \u0275prov=o({token:n,factory:n.\u0275fac,providedIn:"root"})};export{f as a};

<section class="set-password card">
  <!-- Success State -->
  <div *ngIf="success" class="success-state">
    <div class="icon-success">✓</div>
    <h2>Senha definida com sucesso!</h2>
    <p class="success-message">
      A tua senha foi definida com sucesso. Serás redirecionado para o login em alguns segundos...
    </p>
    <div class="actions">
      <button class="btn accent" (click)="goToLogin()">
        Ir para Login
      </button>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !success" class="error-state">
    <div class="icon-error">✕</div>
    <h2>Erro ao definir senha</h2>
    <p class="error-message">{{ errorMessage }}</p>
    <div class="actions">
      <button class="btn ghost" (click)="goToHome()">
        Voltar ao Início
      </button>
      <button class="btn accent" (click)="goToLogin()">
        Ir para Login
      </button>
    </div>
  </div>

  <!-- Form State -->
  <div *ngIf="!success && !error">
    <h2>Define a tua senha</h2>
    <p class="subtitle">Cria uma senha segura para aceder à tua conta.</p>

    <form [formGroup]="passwordForm" (ngSubmit)="onSubmit()" class="form">
      <div class="field pwd">
        <label for="password" class="pwd-label">
          Nova Senha
          <button type="button"
                  class="pwd-emoji-btn"
                  (click)="togglePasswordVisibility()"
                  [attr.aria-label]="showPassword ? 'Ocultar senha' : 'Mostrar senha'">
            <img [src]="showPassword ? 'assets/feliz.png' : 'assets/taparolho.png'"
                 alt=""
                 class="pwd-icon" />
          </button>
        </label>
        <input 
          [type]="showPassword ? 'text' : 'password'"
          id="password"
          formControlName="password"
          placeholder="Mínimo 6 caracteres"
          required>
        <div class="error" *ngIf="passwordForm.get('password')?.touched && passwordForm.get('password')?.hasError('required')">
          Senha é obrigatória
        </div>
        <div class="error" *ngIf="passwordForm.get('password')?.touched && passwordForm.get('password')?.hasError('minlength')">
          Senha deve ter no mínimo 6 caracteres
        </div>
        <div class="password-strength" *ngIf="passwordForm.get('password')?.value && !passwordForm.get('password')?.hasError('minlength')">
          <div class="strength-bar">
            <div class="strength-fill" 
                 [class.weak]="passwordForm.get('password')?.value.length < 8" 
                 [class.medium]="passwordForm.get('password')?.value.length >= 8 && passwordForm.get('password')?.value.length < 12"
                 [class.strong]="passwordForm.get('password')?.value.length >= 12"></div>
          </div>
          <span class="strength-text">
            <span *ngIf="passwordForm.get('password')?.value.length < 8">Fraca</span>
            <span *ngIf="passwordForm.get('password')?.value.length >= 8 && passwordForm.get('password')?.value.length < 12">Média</span>
            <span *ngIf="passwordForm.get('password')?.value.length >= 12">Forte</span>
          </span>
        </div>
      </div>

      <div class="field pwd">
        <label for="confirmPassword" class="pwd-label">
          Confirmar Senha
          <button type="button"
                  class="pwd-emoji-btn"
                  (click)="toggleConfirmPasswordVisibility()"
                  [attr.aria-label]="showConfirmPassword ? 'Ocultar senha' : 'Mostrar senha'">
            <img [src]="showConfirmPassword ? 'assets/feliz.png' : 'assets/taparolho.png'"
                 alt=""
                 class="pwd-icon" />
          </button>
        </label>
        <input 
          [type]="showConfirmPassword ? 'text' : 'password'"
          id="confirmPassword"
          formControlName="confirmPassword"
          placeholder="Digite a senha novamente"
          required>
        <div class="error" *ngIf="passwordForm.get('confirmPassword')?.touched && passwordForm.get('confirmPassword')?.hasError('required')">
          Confirmação de senha é obrigatória
        </div>
        <div class="error" *ngIf="passwordForm.get('confirmPassword')?.touched && passwordForm.hasError('mismatch')">
          As senhas não coincidem
        </div>
      </div>

      <div class="actions">
        <button 
          class="btn accent full-width" 
          type="submit" 
          [disabled]="passwordForm.invalid || loading">
          <span *ngIf="!loading">Definir Senha</span>
          <span *ngIf="loading">Definindo...</span>
        </button>
      </div>
    </form>

    <div class="footer-link">
      <a (click)="goToHome()" class="link">← Voltar ao início</a>
    </div>
  </div>
</section>
